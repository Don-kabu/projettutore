{% extends "base.html" %}

{% block title %}Suivi signalement #{{ fuite.id|stringformat:"05d" }} - Regideso{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8 px-4">
    <div class="max-w-4xl mx-auto">
        
        <!-- Header avec statut -->
        <div class="text-center mb-8">
            <div class="text-6xl mb-4">{{ status_icon }}</div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                Signalement #{{ fuite.id|stringformat:"05d" }}
            </h1>
            <div class="inline-flex items-center px-6 py-3 rounded-full text-lg font-semibold
                {% if status_color == 'success' %}bg-green-100 text-green-800
                {% elif status_color == 'info' %}bg-blue-100 text-blue-800
                {% elif status_color == 'warning' %}bg-yellow-100 text-yellow-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ status_icon }} {{ status_label }}
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="mb-6 p-4 rounded-lg border-l-4 {% if message.tags == 'error' %}bg-red-50 border-red-400 text-red-700{% elif message.tags == 'success' %}bg-green-50 border-green-400 text-green-700{% else %}bg-blue-50 border-blue-400 text-blue-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Progression visuelle -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">üìà Progression du traitement</h2>
            
            <div class="relative">
                <!-- Barre de progression -->
                <div class="flex justify-between items-center mb-8">
                    <div class="flex-1 h-2 bg-gray-200 rounded-full relative overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-1000 ease-out
                            {% if status == 'pending' %}w-1/4
                            {% elif status == 'verified' %}w-1/2
                            {% elif status == 'in_progress' %}w-3/4
                            {% elif status == 'resolved' %}w-full{% endif %}"
                        ></div>
                    </div>
                </div>
                
                <!-- √âtapes -->
                <div class="grid grid-cols-4 gap-4">
                    <!-- √âtape 1: Signal√© -->
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full flex items-center justify-center text-2xl
                            bg-green-100 border-2 border-green-500 text-green-600">
                            ‚úÖ
                        </div>
                        <div class="font-semibold text-green-800">Signal√©</div>
                        <div class="text-sm text-gray-500">{{ fuite.date_creation|date:"d/m/Y" }}</div>
                    </div>
                    
                    <!-- √âtape 2: V√©rifi√© -->
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full flex items-center justify-center text-2xl
                            {% if status == 'verified' or status == 'in_progress' or status == 'resolved' %}
                                bg-green-100 border-2 border-green-500 text-green-600
                            {% else %}
                                bg-gray-100 border-2 border-gray-300 text-gray-400
                            {% endif %}">
                            {% if status == 'verified' or status == 'in_progress' or status == 'resolved' %}‚úÖ{% else %}‚è≥{% endif %}
                        </div>
                        <div class="font-semibold {% if status == 'verified' or status == 'in_progress' or status == 'resolved' %}text-green-800{% else %}text-gray-500{% endif %}">
                            V√©rifi√©
                        </div>
                        <div class="text-sm text-gray-500">
                            {% if fuite.verified_opt %}{{ fuite.verified_opt|date:"d/m/Y" }}{% endif %}
                        </div>
                    </div>
                    
                    <!-- √âtape 3: En cours -->
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full flex items-center justify-center text-2xl
                            {% if status == 'in_progress' or status == 'resolved' %}
                                bg-blue-100 border-2 border-blue-500 text-blue-600
                            {% else %}
                                bg-gray-100 border-2 border-gray-300 text-gray-400
                            {% endif %}">
                            {% if status == 'in_progress' %}üîÑ{% elif status == 'resolved' %}‚úÖ{% else %}‚è∏Ô∏è{% endif %}
                        </div>
                        <div class="font-semibold {% if status == 'in_progress' or status == 'resolved' %}text-blue-800{% else %}text-gray-500{% endif %}">
                            En cours
                        </div>
                        <div class="text-sm text-gray-500">
                            {% if mission %}{{ mission.date_creation|date:"d/m/Y" }}{% endif %}
                        </div>
                    </div>
                    
                    <!-- √âtape 4: R√©solu -->
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full flex items-center justify-center text-2xl
                            {% if status == 'resolved' %}
                                bg-green-100 border-2 border-green-500 text-green-600
                            {% else %}
                                bg-gray-100 border-2 border-gray-300 text-gray-400
                            {% endif %}">
                            {% if status == 'resolved' %}üéâ{% else %}‚è≥{% endif %}
                        </div>
                        <div class="font-semibold {% if status == 'resolved' %}text-green-800{% else %}text-gray-500{% endif %}">
                            R√©solu
                        </div>
                        <div class="text-sm text-gray-500"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- D√©tails du signalement -->
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Informations g√©n√©rales -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                    üìã D√©tails du signalement
                </h3>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="font-medium text-gray-700">üìÖ Date signalement</span>
                        <span class="text-gray-900">{{ fuite.date_creation|date:"d/m/Y √† H:i" }}</span>
                    </div>
                    
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="font-medium text-gray-700">üë§ Signal√© par</span>
                        <span class="text-gray-900">{{ fuite.complaint_name|default:"Citoyen" }}</span>
                    </div>
                    
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="font-medium text-gray-700">üìç Quartier</span>
                        <span class="text-gray-900">{{ fuite.quartier|default:"Non sp√©cifi√©" }}</span>
                    </div>
                    
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="font-medium text-gray-700">üè¢ Commune</span>
                        <span class="text-gray-900">{{ fuite.commune|default:"Non sp√©cifi√©e" }}</span>
                    </div>
                    
                    {% if fuite.adresse %}
                    <div class="flex justify-between items-start py-3 border-b border-gray-100">
                        <span class="font-medium text-gray-700">üè† Adresse</span>
                        <span class="text-gray-900 text-right max-w-xs">{{ fuite.adresse }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="font-medium text-gray-700">‚ö° Gravit√©</span>
                        <span class="text-gray-900">
                            {% if fuite.gravite == 'critique' %}
                                <span class="text-red-600 font-semibold">üö® Critique</span>
                            {% elif fuite.gravite == 'moyenne' %}
                                <span class="text-yellow-600 font-semibold">‚ö†Ô∏è Moyenne</span>
                            {% else %}
                                <span class="text-green-600 font-semibold">‚ÑπÔ∏è Faible</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    {% if fuite.description %}
                    <div class="py-3">
                        <span class="font-medium text-gray-700 block mb-2">üìù Description</span>
                        <p class="text-gray-900 bg-gray-50 rounded-lg p-3">{{ fuite.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Mission et feedback -->
            <div class="space-y-6">
                <!-- Feedback selon l'√©tat -->
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                        üí¨ √âtat actuel
                    </h3>
                    
                    {% if status == 'pending' %}
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="text-2xl mr-3">‚è≥</div>
                                <div>
                                    <h4 class="font-semibold text-yellow-800 mb-2">En attente de v√©rification</h4>
                                    <p class="text-yellow-700 text-sm">
                                        Votre signalement a √©t√© re√ßu et est en cours de v√©rification par nos √©quipes. 
                                        Nous examinerons les d√©tails dans les plus brefs d√©lais.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                    {% elif status == 'verified' %}
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="text-2xl mr-3">‚úÖ</div>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Signalement v√©rifi√©</h4>
                                    <p class="text-blue-700 text-sm">
                                        Votre signalement a √©t√© v√©rifi√© et valid√©. Une mission d'intervention 
                                        va √™tre programm√©e prochainement par nos √©quipes techniques.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                    {% elif status == 'in_progress' %}
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="text-2xl mr-3">üîÑ</div>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">Intervention en cours</h4>
                                    <p class="text-blue-700 text-sm">
                                        Nos techniciens sont actuellement sur le terrain et travaillent 
                                        activement √† la r√©solution de votre signalement.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                    {% elif status == 'resolved' %}
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="text-2xl mr-3">üéâ</div>
                                <div>
                                    <h4 class="font-semibold text-green-800 mb-2">Probl√®me r√©solu</h4>
                                    <p class="text-green-700 text-sm">
                                        Excellente nouvelle ! Le probl√®me de fuite d'eau a √©t√© r√©solu avec succ√®s. 
                                        Merci pour votre signalement citoyen !
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Mission si disponible -->
                {% if mission %}
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                        üõ†Ô∏è Mission d'intervention
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="font-medium text-gray-700">üÜî Num√©ro mission</span>
                            <span class="text-gray-900 font-mono">#{{ mission.id|stringformat:"05d" }}</span>
                        </div>
                        
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="font-medium text-gray-700">üìÖ Planifi√©e le</span>
                            <span class="text-gray-900">{{ mission.date_creation|date:"d/m/Y" }}</span>
                        </div>
                        
                        {% if mission.date_prevue %}
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="font-medium text-gray-700">‚è∞ Intervention pr√©vue</span>
                            <span class="text-gray-900 font-semibold">{{ mission.date_prevue|date:"d/m/Y" }}</span>
                        </div>
                        {% endif %}
                        
                        {% if mission.resolver_phone %}
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="font-medium text-gray-700">üìû Contact √©quipe</span>
                            <span class="text-gray-900">{{ mission.resolver_phone }}</span>
                        </div>
                        {% endif %}
                        
                        {% if mission.description %}
                        <div class="py-2">
                            <span class="font-medium text-gray-700 block mb-2">üìù Description mission</span>
                            <p class="text-gray-900 bg-gray-50 rounded-lg p-3 text-sm">{{ mission.description|truncatewords:30 }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Bouton de rappel -->
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        üì± Besoin d'aide ?
                    </h3>
                    
                    <p class="text-gray-600 mb-6">
                        {% if status == 'pending' %}
                            Pas re√ßu de retour ? Faites un rappel pour relancer la v√©rification.
                        {% elif status == 'verified' %}
                            Mission pas encore planifi√©e ? Faites un rappel pour acc√©l√©rer le processus.
                        {% elif status == 'in_progress' %}
                            Intervention trop longue ? Contactez l'√©quipe pour un point d'avancement.
                        {% else %}
                            Probl√®me toujours pr√©sent ? Contactez notre support.
                        {% endif %}
                    </p>
                    
                    <form method="post" class="space-y-4" id="rappelForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="rappel">
                        
                        <button 
                            type="submit" 
                            class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-4 px-6 rounded-xl font-semibold hover:from-orange-600 hover:to-orange-700 focus:outline-none focus:ring-4 focus:ring-orange-500/50 transform hover:scale-[1.02] transition-all duration-200 shadow-lg"
                            id="rappelBtn"
                        >
                            üì¢ Faire un rappel
                        </button>
                    </form>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <p class="text-sm text-gray-500">
                            üí° <strong>Conseil :</strong> En cas d'urgence, contactez directement notre service au 
                            <strong>+243 XXX XXX XXX</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Retour -->
        <div class="mt-8 text-center">
            <a href="{% url 'recherche_signalement' %}" class="inline-flex items-center text-gray-600 hover:text-gray-800 font-medium">
                ‚Üê Rechercher un autre signalement
            </a>
            <span class="mx-4 text-gray-400">|</span>
            <a href="{% url 'accueil' %}" class="inline-flex items-center text-gray-600 hover:text-gray-800 font-medium">
                üè† Retour √† l'accueil
            </a>
        </div>
    </div>
</div>

<script>
// Gestion du bouton de rappel avec feedback
document.getElementById('rappelForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('rappelBtn');
    
    // D√©sactiver le bouton et changer le texte
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Envoi en cours...';
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    
    // R√©activer apr√®s 3 secondes (en cas d'√©chec)
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = 'üì¢ Faire un rappel';
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
    }, 3000);
});

// Animation d'entr√©e pour les cartes
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.bg-white');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}